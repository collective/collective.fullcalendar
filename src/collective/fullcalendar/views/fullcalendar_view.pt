<html xmlns="http://www.w3.org/1999/xhtml"
      xmlns:metal="http://xml.zope.org/namespaces/metal"
      xmlns:tal="http://xml.zope.org/namespaces/tal"
      xmlns:i18n="http://xml.zope.org/namespaces/i18n"
      i18n:domain="collective.fullcalendar"
      metal:use-macro="context/main_template/macros/master">
<body>
  <metal:block fill-slot="content-core">

    <div id="calendar" />
    <div id="calendarEditArea" />

    <tal:block tal:replace="nothing">
        Modal throws error, as long as not fixed it will stay out of the code
        <a id="calendarAddLink" class="pat-plone-modal" href="/Plone/++add++Event?ajax_load=1"></a>
        <tal:block tal:repeat="event python:view._get_events()">
        <a class="pat-plone-modal"
            tal:attributes="id python:'editlink-'+event['id'];
                            href python:event['url']+'/@@edit'">
        </a>
        </tal:block>
    </tal:block>
    <script>
        document.addEventListener('DOMContentLoaded', function() {

        var calendarElement = document.getElementById('calendar');
        var calendarEditArea = $('#calendarEditArea');
        var parentURL = '<tal:block tal:content="structure python:context.aq_parent.absolute_url()" />';

        var calendar = new FullCalendar.Calendar(calendarElement, {
            timeZone: 'UTC',
            slotDuration: '<tal:block tal:content="structure python:view.get_slot_minutes()" />',
            allDaySlot: <tal:block tal:content="structure python:view.get_all_day()" />,
            initialView: '<tal:block tal:content="structure python:context.defaultCalendarView" />',
            locale: '<tal:block tal:content="python:view.current_language()" />',
            firstDay: <tal:block tal:content="structure python:view.get_first_day()" />,
            headerToolbar: {
                left: '<tal:block tal:content="structure python:context.headerLeft" />',
                center: 'title',
                right: '<tal:block tal:content="structure python:context.headerRight" />',
            },
            weekends: <tal:block tal:content="structure python:view.get_weekends()" />,
            scrollTime: '<tal:block tal:content="structure python:view.get_first_hour()" />',
            slotMinTime: '<tal:block tal:content="structure python:view.get_min_time()" />',
            slotMaxTime: '<tal:block tal:content="structure python:view.get_max_time()" />',
            <tal:block tal:condition="python:context.calendarHeight">
            height: <tal:block tal:content="structure python:context.calendarHeight" />,
            </tal:block>
            editable: <tal:block tal:content="structure python:view.get_editable()" />,
            selectable: <tal:block tal:content="structure python:view.get_editable()" />,
            events: <tal:block tal:content="structure python:view.render_events()" />,
            // Auswahl eines Bereichs: Bei Monatsansicht werden mehrtägige Termine erstellt, ansonsten Termin in Bereichsgröße
            select: function(info) {
                start = info.startStr;
                end = info.endStr;
                $('a#calendarAddLink').click();
                //console.log(start);
                //console.log(end);
                //$('#formfield-form-widgets-IEventBasic-start input')
                //calendarEditArea.load(parentURL+'/++add++Event?ajax_load=1',function(responseTxt, statusTxt, xhr){
                    //if(statusTxt == "success")
                    //    alert("External content loaded successfully!");
                    //if(statusTxt == "error")
                    //   alert("Error: " + xhr.status + ": " + xhr.statusText);
                    //$('#form').attr('target','calendarTargetArea');
                    //$('#form').on('submit',function(){$('#form').remove()});
                // });
            },
            // Klick auf einen Slot. Bei Monatsansicht wird ganztägiger Termin erstellt, ansonsten Termin in Slotgröße
            dateClick: function(info) {
                start = info.startStr;
                end = info.endStr;
                $('a#calendarAddLink').click();
            },
            // Klick auf einen Termin
            eventClick: function(info) {
                $('#editlink-'+info.event.id).click();
                //alert('Event: ' + info.event.title);
                //alert('Event: ' + );
                //alert('Coordinates: ' + info.jsEvent.pageX + ',' + info.jsEvent.pageY);
                //alert('View: ' + info.view.type);
                // change the border color just for fun
                //info.el.style.borderColor = 'red';
            },
            // Vergrößern/Verkleinern eines Termins
            eventResize: function(info) {
                //alert(info.event.title + " end is now " + info.event.end.toISOString());
                if (confirm("is this okay?")) {
                    window.location.href = "@@edit-event?method=resize&uid="+info.event.id+"&new_end="+info.event.end.toISOString();
                } else {
                    info.revert();
                }
            },
            // Verschieben eines Termins
            eventDrop: function(info) {
                if (confirm("is this okay?")) {
                    window.location.href = "@@edit-event?method=move&uid="+info.event.id+"&new_start="+info.event.start.toISOString()+"&new_end="+info.event.end.toISOString();
                } else {
                    info.revert();
                }
            }
        });

        calendar.render();
        });
    </script>


  </metal:block>
</body>
</html>
